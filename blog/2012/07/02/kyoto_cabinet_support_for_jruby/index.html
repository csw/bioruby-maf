
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Kyoto Cabinet support for JRuby - BioRuby MAF blog</title>
  <meta name="author" content="Clayton Wheeler">

  
  <meta name="description" content="Kyoto Cabinet is a useful database, with a convenient
Ruby binding; unfortunately, this uses Ruby&#8217;s C extension API and
so does not work with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://csw.github.com/bioruby-maf/blog/2012/07/02/kyoto_cabinet_support_for_jruby">
  <link href="/bioruby-maf/favicon.png" rel="icon">
  <link href="/bioruby-maf/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/bioruby-maf/javascripts/modernizr-2.0.js"></script>
  <script src="/bioruby-maf/javascripts/ender.js"></script>
  <script src="/bioruby-maf/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/bioruby-maf/atom.xml" rel="alternate" title="BioRuby MAF blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/bioruby-maf/">BioRuby MAF blog</a></h1>
  
    <h2>Multiple Alignment Format support for BioRuby and bio-alignment</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/bioruby-maf/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:csw.github.com/bioruby-maf" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/bioruby-maf/">Blog</a></li>
  <li><a href="/bioruby-maf/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Kyoto Cabinet Support for JRuby</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-02T16:01:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://fallabs.com/kyotocabinet/">Kyoto Cabinet</a> is a useful database, with a convenient
<a href="http://fallabs.com/kyotocabinet/rubydoc/">Ruby binding</a>; unfortunately, this uses Ruby&#8217;s C extension API and
so does not work with JRuby. Since JRuby has a considerable
performance advantage over MRI for my <a href="https://github.com/csw/bioruby-maf">MAF parser</a>, I needed a way
of using Kyoto Cabinet from JRuby. I have released the
<a href="https://github.com/csw/kyotocabinet-java">kyotocabinet-java</a> gem to provide this. It is not complete, but it
wraps enough of the API for my needs, and the rest should be simple to
cover.</p>

<p>This gem contains a patched copy of the Kyoto Cabinet
<a href="http://fallabs.com/kyotocabinet/javapkg/">Java library</a>, along with a thin Ruby adaptation layer to provide
the usual Ruby API. Since the underlying Java library relies on native
code integrated with JNI, installing the gem compiles the native
library and associated Java code, and thus requires a JDK and working
C++ compiler as well as a Kyoto Cabinet installation.</p>

<p>Mapping the Java API onto the Ruby API is generally quite simple.  The
chief issue is ensuring that Ruby strings are converted to Java byte
arrays rather then Java strings; the Java string versions of the API
methods fail completely with binary data. Also, the Java API lacks the
Ruby API&#8217;s optional parameters. For instance, here is <a href="https://github.com/csw/kyotocabinet-java/blob/c51e23a4fee077229b0ffdf4b66d323b33635704/lib/kyotocabinet.rb#L105">DB#get</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">alias_method</span> <span class="ss">:_get</span><span class="p">,</span> <span class="ss">:get</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ret_bytes</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">to_java_bytes</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few methods needed a tiny bit more work, such as <code>DB#set_bulk</code> and
<code>DB#cursor_process</code>, but as you can see from <a href="https://github.com/csw/kyotocabinet-java/blob/master/lib/kyotocabinet.rb">kyotocabinet.rb</a>, it
wasn&#8217;t much.</p>

<p>Using this and the <code>kyotocabinet-ruby</code> library interchangeably for MRI
and JRuby support in a Bundler application is straightforward:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;kyotocabinet-ruby&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.27.1&quot;</span><span class="p">,</span> <span class="ss">:platforms</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:mri</span><span class="p">,</span> <span class="ss">:rbx</span><span class="o">]</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;kyotocabinet-java&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 0.2.0&quot;</span><span class="p">,</span> <span class="ss">:platforms</span> <span class="o">=&gt;</span> <span class="ss">:jruby</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, if you are developing a gem as I am with
<a href="https://github.com/csw/bioruby-maf">bioruby-maf</a>, things are not quite so simple. While Bundler makes
it easy to require different gems depending on one&#8217;s current Ruby
platform, <a href="http://docs.rubygems.org/read/chapter/20">Gem::Specification</a> provides no such feature. I ended up
making a <a href="https://github.com/csw/bioruby-maf/blob/eda7485e61aba4978ba16a6abcdc95b8094a722d/bio-maf.gemspec#L102">gemspec</a> that builds two different versions of the gem: a
<code>java</code> platform variant that depends on <code>kyotocabinet-java</code>, and a
&#8216;normal&#8217; gem with no platform specified that depends on
<code>kyotocabinet-ruby</code>. This is a bit cumbersome; it requires running
<code>gem build</code> under both JRuby and MRI to build both versions of the
gem, and meant that I had to abandon use of Jeweler. Nonetheless, it
works; under JRuby, <code>gem install bio-maf</code> will pull in the Java
variant and <code>kyotocabinet-java</code>, while under MRI it will pull in the
&#8216;normal&#8217; gem and <code>kyotocabinet-ruby</code>. The relevant part of the gemspec
is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">RUBY_PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">[.</span><span class="n">.</span><span class="o">.]</span>
</span><span class='line'><span class="k">if</span> <span class="no">RUBY_PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">add_runtime_dependency</span><span class="p">(</span><span class="s1">&#39;kyotocabinet-java&#39;</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;~&gt; 0.2.0&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="n">add_runtime_dependency</span><span class="p">(</span><span class="s1">&#39;kyotocabinet-ruby&#39;</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;~&gt; 1.27.1&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ultimately, it might be worth contacting the maintainer of the
<code>kyotocabinet-ruby</code> gem and seeing about packaging this as a platform
variant, to sidestep all this. For the time being, though, this works.</p>

<p>A note on performance: I found JRuby&#8217;s ObjectProxyCache to be a major
performance bottleneck, especially for multithreaded access to Kyoto
Cabinet. Starting JRuby with the <code>-Xji.objectProxyCache=false</code> option
gave about a 2.5x speedup for Kyoto Cabinet searches. If the rest of
your JRuby code works with this option (which will be the default in
JRuby 2.0, anyway), I highly recommend using it.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Clayton Wheeler</span></span>

      








  


<time datetime="2012-07-02T16:01:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://csw.github.com/bioruby-maf/blog/2012/07/02/kyoto_cabinet_support_for_jruby/" data-via="" data-counturl="http://csw.github.com/bioruby-maf/blog/2012/07/02/kyoto_cabinet_support_for_jruby/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/bioruby-maf/blog/2012/06/21/parallel_io/" title="Previous Post: Parallel I/O">&laquo; Parallel I/O</a>
      
      
        <a class="basic-alignment right" href="/bioruby-maf/blog/2012/07/09/bio-maf_0.2.0/" title="Next Post: Bio-MAF 0.2.0">Bio-MAF 0.2.0 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/bioruby-maf/blog/2012/08/21/bio-maf_1.0.1/">Bio-MAF 1.0.1</a>
      </li>
    
      <li class="post">
        <a href="/bioruby-maf/blog/2012/08/05/bgzf_and_testing/">BGZF and testing</a>
      </li>
    
      <li class="post">
        <a href="/bioruby-maf/blog/2012/07/18/bio-maf_0.3.0/">Bio-MAF 0.3.0</a>
      </li>
    
      <li class="post">
        <a href="/bioruby-maf/blog/2012/07/09/bio-maf_0.2.0/">Bio-MAF 0.2.0</a>
      </li>
    
      <li class="post">
        <a href="/bioruby-maf/blog/2012/07/02/kyoto_cabinet_support_for_jruby/">Kyoto Cabinet support for JRuby</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/csw">@csw</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'csw',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/bioruby-maf/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Clayton Wheeler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'biorubymafblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://csw.github.com/bioruby-maf/blog/2012/07/02/kyoto_cabinet_support_for_jruby/';
        var disqus_url = 'http://csw.github.com/bioruby-maf/blog/2012/07/02/kyoto_cabinet_support_for_jruby/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
